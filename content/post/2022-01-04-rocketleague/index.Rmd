---
title: "When Should You Forfeit in Rocket League?"
author: "Harris Kingsley"
date: "1/4/2022"
output: html_document
---

```{r setup, include=FALSE}
library(ggplot2)
library(dplyr)
rl <- read.csv("stats.csv")

```

Since the pandemic started I've been playing more and more Rocket League, a video game which is essentially soccer with cars. . Unfortunately, I'm not a great player and I often end up in game situations where I'm losing by multiple goals. While games in Rocket League aren't particularly long, they usually last about 8 minutes or so, the game does give you an option to forfeit your match early. This begs the question : at what point is the game hopeless and forfeiting makes sense? \
\
To begin to answer this question I needed to gain a deeper understanding of the Rocket League scoring envioment. There are 3 main game modes in Rocket League; singles, duos, and trios. Additionally players are split up into one of 7 ranks based on their skill level. These range from Bronze (the lowest) to Grand Champion. Each of these rank and game mode combinations have their own scoring environment. Pulling population level data in Rocket League was tricky. From my research it appears the developers have been promising a public API for some time but I could not find a way to access it as of yet. Luckily when this game belonged to an old publisher they did have public data and the website (ballchasing.com)\[ <https://ballchasing.com/population/distribution>\] published a lot of that older data. So this data is from games a little over a year ago and are not current its the best I was able to track down and I have no reason to believe this data has dramatically changed. Below is chart with average total goals scored per game across all ranks and game modes.

```{r cars}
library(magick)
library(cowplot)
rl_long<- rl%>%
  tidyr::pivot_longer(cols = Bronze:GC, values_to = "Goals", names_to = "Rank")%>%
  mutate(Rank = factor(Rank, levels = c("Bronze", "Silver", "Gold", "Plat", "Diamond", "Champ", "GC")),
         Mode = factor(Mode, levels = c("Solo", "Duos", "Trios"))
         )
## add axis labels and maybe logos 
ggplot(rl_long, aes(x= Rank, y = Goals, fill = Rank ))+
  geom_bar(stat = "identity")+
  theme_minimal()+
  coord_flip()+
  theme(legend.position = "none") + 
  ggtitle("Goals Per Game") + 
  scale_fill_manual(values = c("GC" = "#E73E95", "Champ" = "#C628D5", "Diamond" = "#154ADE", "Plat" = "#15CADE", "Gold"= "#DEA415", "Silver" = "#8CA0A5", "Bronze" = "#9A5E0D")  ) +
  draw_image("grand_champ.jpg", x = 6.5, y = 0.2, scale = 1)+
  draw_image("champ.jpg", x = 5.5, y = 0.2, scale = 1.2)+
  draw_image("diamand.jpg", x = 4.5, y = 0.2, scale =  1.2)+
  draw_image("plat.jpg", x = 3.5, y = 0.2, scale = 1.2)+
  draw_image("gold.jpg", x = 2.5, y = 0.2, scale = 1.2)+
  draw_image("silver.jpg", x = 1.5, y = 0.2, scale = 1.2)+
  draw_image("bronze.jpg", x = 0.5, y = 0.2, scale = 1.2)+
  facet_wrap(~Mode)
```

Now that we have the average goals per game we can start to do the work of finding when forfeiting makes sense. We can use the [poisson distribution](https://en.wikipedia.org/wiki/Poisson_distribution) with the average goals per game data to find the probability of winning a game or at least forcing OT based on how much time is left and how many goals a team is losing by. We treat the average goals per game as the lamda for the poisson distribution and adjust down linearly based on how much game time is left. This distribution is best as allows us to get a probability distribution of discrete events (goals scored) best on a certain lamda (average goals scored in a given time frame). \
\
If you are interested any more in the methodology my full code can me found on my github. Below is the result of using the possion mehod on all game modes and ranks. The columns of the tables are the goal differential at your current point in time. The rows is the time remaining in the game. The values are the probability that your team forces OT or wins the game in regulation. For example for Duo Plat (my favorite and my rank) if my teammate and I were losing by 2 (-2 differnational) with 2 minutes left in the game we would still have a 14% of at least tieing the game. I probably wouldn't forfeit in that situtation, but if we give up another goal then our odds fall to just 4%. \
\
The big assumption here is that both teams are equally good. I believe the ranks in rocket league do a good job of splitting players into approriate skill levels, however teamwork is incredibly important in duos and trios and some teammates may work together better than others. \
\

```{r pressure, echo=FALSE}
rl_long <- rl_long%>%
  mutate(goals_per_minute = Goals / 5)
  
# diff: how many goals the team is down by 
# lambda: how many expected goals in the given time frame for both teams 
# limit: how many goals to search through
calc_prob_tie <- function(diff, lambda, limit = 10) {
  diff <- diff * -1 
  goal_seq <- diff:limit
  probs <- sapply(goal_seq, function(x) {dpois(x, lambda) })
  probs_less <-  sapply(goal_seq - diff , function(x) {ppois(x, lambda, lower.tail = T) })
  return(round(sum(probs * probs_less) * 100,0))
}  
  
#lambda is goal per minute
build_df <- function(lambda) {
  
  times <- c(4,3,2,1,.5)
  diff <- -4:4
  grid <- as.data.frame(expand.grid(times, diff))
  colnames(grid) <- c("Time", "Diff")
  grid$Prob <- mapply(calc_prob_tie, diff = grid$Diff, lambda = lambda * grid$Time)
  grid <- grid%>% 
    tidyr::pivot_wider(names_from = Diff, values_from = Prob)%>%
    select(-Time)
      
  return(grid) 
}




```

```{r pressure, echo=FALSE, fig.height=20, fig.width= 12}
library(gridExtra)
plot_list <- lapply( rl_long$goals_per_minute,  function(x) gridExtra::tableGrob(build_df(x), rows = c("4:00", "3:00", "2:00", "1:00" , "0:30")))
rl_long <- rl_long%>%arrange(Rank)
lab_vector <- paste( rl_long$Mode, rl_long$Rank)
cowplot::plot_grid(plotlist = plot_list, ncol = 3, nrow = 7, byrow = FALSE, labels = lab_vector)



```
